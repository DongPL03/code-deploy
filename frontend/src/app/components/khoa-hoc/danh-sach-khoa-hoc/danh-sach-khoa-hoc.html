@if (!loading) {
  <div class="inventory-container">
    <header class="inventory-header">
      <div class="header-content">
        <h1>üìö Kh√≥a H·ªçc</h1>
        <p>Kh√°m ph√° c√°c kh√≥a h·ªçc ƒë∆∞·ª£c t·ªï ch·ª©c theo l·ªô tr√¨nh h·ªçc
          t·∫≠p.</p>
      </div>
      @if (isAdmin()) {
        <button class="btn-hero-3d" (click)="navigateToCreate()">
          <span class="btn-icon"><i class="fas fa-plus"></i></span>
          <span class="btn-text">T·∫°o Kh√≥a H·ªçc M·ªõi</span>
        </button>
      }
    </header>
    <div class="inventory-layout">
      <aside class="control-panel">
        <div class="panel-header" (click)="toggleMobileFilter()">
          <div class="panel-title">
            <i class="fas fa-sliders-h"></i> B·ªô L·ªçc
          </div>
          <i class="fas fa-chevron-down mobile-toggle-icon"
             [class.rotate]="isMobileFilterOpen"></i>
        </div>

        <div class="filter-content" [class.show-mobile]="isMobileFilterOpen">

          <div class="filter-group">
            <div class="search-hud">
              <i class="fas fa-search"></i>
              <input [(ngModel)]="keyword" (keyup.enter)="applyFilter()"
                     placeholder="T√¨m ki·∫øm..." />
            </div>
          </div>

          <div class="filter-group">
            <label class="group-label">S·∫Øp x·∫øp</label>
            <div class="custom-dropdown-container">
              <div class="dropdown-trigger" (click)="toggleSortDropdown()">
                <span class="selected-text">{{ getSortLabel() }}</span>
                <i class="fas fa-chevron-down arrow" [class.rotate]="showSortDropdown"></i>
              </div>

              @if (showSortDropdown) {
                <div class="dropdown-options-list animate-fade-down">
                  <div class="dropdown-item" [class.active]="sortOrder === 'NEWEST'" (click)="selectSort('NEWEST')">üïê M·ªõi nh·∫•t</div>
                  <div class="dropdown-item" [class.active]="sortOrder === 'OLDEST'" (click)="selectSort('OLDEST')">üìÖ C≈© nh·∫•t</div>
                  <div class="dropdown-item" [class.active]="sortOrder === 'RATING_DESC'" (click)="selectSort('RATING_DESC')">‚≠ê ƒê√°nh gi√° cao</div>
                  <div class="dropdown-item" [class.active]="sortOrder === 'RATING_ASC'" (click)="selectSort('RATING_ASC')">‚≠ê ƒê√°nh gi√° th·∫•p</div>
                </div>
                <div class="backdrop-click" (click)="closeAllDropdowns()"></div>
              }
            </div>
          </div>

          <div class="filter-group">
            <label class="group-label">Ch·ªß ƒë·ªÅ</label>
            <div class="custom-dropdown-container">
              <div class="dropdown-trigger" (click)="toggleChuDeDropdown()">
                <span class="selected-text">{{ getChuDeLabel() }}</span>
                <i class="fas fa-chevron-down arrow" [class.rotate]="showChuDeDropdown"></i>
              </div>

              @if (showChuDeDropdown) {
                <div class="dropdown-options-list animate-fade-down">
                  <div class="dropdown-item" [class.active]="chuDeId === 0" (click)="selectChuDe(0)">üìö T·∫•t c·∫£ ch·ªß ƒë·ªÅ</div>
                  @for (cd of chuDes; track cd.id) {
                    <div class="dropdown-item" [class.active]="chuDeId === cd.id" (click)="selectChuDe(cd.id)">
                      {{ cd.ten }}
                    </div>
                  }
                </div>
                <div class="backdrop-click" (click)="closeAllDropdowns()"></div>
              }
            </div>
          </div>

          <div class="filter-group">
            <label class="group-label">Tr·∫°ng th√°i</label>
            <div class="custom-dropdown-container">
              <div class="dropdown-trigger" (click)="toggleTrangThaiDropdown()">
                <span class="selected-text">{{ getTrangThaiLabel() }}</span>
                <i class="fas fa-chevron-down arrow" [class.rotate]="showTrangThaiDropdown"></i>
              </div>

              @if (showTrangThaiDropdown) {
                <div class="dropdown-options-list animate-fade-down">
                  @for (opt of trangThaiOptions; track opt.value) {
                    <div class="dropdown-item" [class.active]="trangThai === opt.value" (click)="selectTrangThai(opt.value)">
                      {{ opt.label }}
                    </div>
                  }
                </div>
                <div class="backdrop-click" (click)="closeAllDropdowns()"></div>
              }
            </div>
          </div>

        </div>
      </aside>

      <main class="card-grid-area">
        @if (items.length > 0) {
          <div class="card-grid">
            @for (khoaHoc of items; track khoaHoc.id) {
              <div class="skill-card" [ngClass]="{
                     'status-published': khoaHoc.trang_thai === 'CONG_KHAI',
                     'status-draft': khoaHoc.trang_thai === 'BAN_NHAP',
                     'status-archived': khoaHoc.trang_thai === 'LUU_TRU'
                   }">
                <div class="card-top">
                  <div class="icon-box">
                    <i class="fas fa-graduation-cap"></i>
                  </div>
                  <div class="badges-stack">
                            <span class="badge-pill status-badge">
                                @if (khoaHoc.trang_thai ===
                                'PUBLISHED') {
                                  <i class="fas fa-check-circle"></i> ƒê√£
                                    xu·∫•t b·∫£n
                                } @else if (khoaHoc.trang_thai ===
                                'DRAFT') {
                                  <i class="fas fa-edit"></i> B·∫£n nh√°p
                                } @else if (khoaHoc.trang_thai ===
                                'ARCHIVED') {
                                  <i class="fas fa-archive"></i> ƒê√£ l∆∞u
                                    tr·ªØ
                                }
                            </span>
                    @if (khoaHoc.so_bo_cau_hoi &&
                    khoaHoc.so_bo_cau_hoi > 0) {
                      <span class="badge-pill count-badge">
                                <i class="fas fa-book"></i> {{
                          khoaHoc.so_bo_cau_hoi
                        }} b·ªô
                            </span>
                    }
                  </div>
                </div>

                <div class="card-body">
                        <span class="category-tag">{{
                            khoaHoc.chu_de
                            || 'General'
                          }}</span>
                  <h3 class="card-title">{{ khoaHoc.tieu_de }}
                  </h3>
                  <div class="card-meta">
                            <span class="meta-item">
                                <i class="fas fa-user-astronaut"></i>
                              {{ khoaHoc.nguoi_tao || '·∫®n danh' }}
                            </span>
                            @if ((khoaHoc.tong_danh_gia ?? 0) > 0) {
                              <span class="meta-item rating-display">
                                <i class="fas fa-star text-warning"></i>
                                {{ khoaHoc.trung_binh_sao | number:'1.1-1' }}
                                <span class="rating-count">({{ khoaHoc.tong_danh_gia }})</span>
                              </span>
                            }
                  </div>
                  <p class="card-desc">{{ khoaHoc.mo_ta || 'Ch∆∞a c√≥ m√¥ t·∫£ cho kh√≥a h·ªçc n√†y.' }}</p>
                </div>

                <div class="card-actions">
                  <button class="action-btn btn-view"
                          (click)="navigateToDetail(khoaHoc.id)"
                          title="Xem chi ti·∫øt">
                    <i class="fas fa-eye"></i>
                  </button>

                  @if (canEditOrDelete(khoaHoc)) {
                    <button class="action-btn btn-edit"
                            (click)="navigateToEdit(khoaHoc.id)"
                            title="Ch·ªânh s·ª≠a">
                      <i class="fas fa-pen"></i>
                    </button>

                    <button class="action-btn btn-delete"
                            (click)="onDelete(khoaHoc.id)"
                            title="X√≥a">
                      <i class="fas fa-trash"></i>
                    </button>
                  }
                </div>
              </div>
            }
          </div>

          @if (totalPages > 1) {
            <div class="pagination-wrapper">
              <button class="page-btn nav-prev" (click)="changePage(page - 1)" [disabled]="page === 0">
                <i class="fas fa-chevron-left"></i>
              </button>

              <div class="page-numbers">
                @for (p of getVisiblePages(); track $index) {
                  @if (p >= 0) {
                    <button class="page-btn" [class.active]="p === page" (click)="changePage(p)">
                      {{ p + 1 }}
                    </button>
                  } @else {
                    <span class="dots">...</span>
                  }
                }
              </div>

              <button class="page-btn nav-next" (click)="changePage(page + 1)" [disabled]="page === totalPages - 1">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          }
        } @else {
          <div class="empty-state-card">
            <img src="https://cdn-icons-png.flaticon.com/512/7486/7486747.png"
                 alt="Empty">
            <h3>Ch∆∞a c√≥ kh√≥a h·ªçc n√†o!</h3>
            <p>Ch∆∞a t√¨m th·∫•y kh√≥a h·ªçc n√†o ph√π h·ª£p.</p>
          </div>
        }
      </main>
    </div>
  </div>
} @else {
  <div class="loading-screen">
    <div class="spinner-box">
      <div class="spinner"></div>
      <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
    </div>
  </div>
}
