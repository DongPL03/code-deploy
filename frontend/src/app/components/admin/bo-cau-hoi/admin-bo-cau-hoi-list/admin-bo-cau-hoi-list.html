<div class="admin-bch-container animate-fade-down">

  <div class="page-header">
    <div>
      <h2 class="page-title">Quản lý bộ câu hỏi</h2>
      <p class="page-subtitle">Kiểm duyệt và quản lý kho tri thức của hệ thống.</p>
    </div>
    <button class="btn-create" (click)="goToCreateAdminBo()">
      <i class="fas fa-plus-circle"></i> Tạo mới
    </button>
  </div>

  @if (statistics) {
    <div class="stats-grid">
      <div class="stat-card blue">
        <div class="icon"><i class="fas fa-layer-group"></i></div>
        <div class="info">
          <span class="lbl">Tổng số</span>
          <span class="val">{{ statistics.total | number }}</span>
        </div>
      </div>
      <div class="stat-card orange">
        <div class="icon"><i class="fas fa-clock"></i></div>
        <div class="info">
          <span class="lbl">Chờ duyệt</span>
          <span class="val">{{ statistics.choDuyet | number }}</span>
        </div>
      </div>
      <div class="stat-card green">
        <div class="icon"><i class="fas fa-check-circle"></i></div>
        <div class="info">
          <span class="lbl">Đã duyệt</span>
          <span class="val">{{ statistics.daDuyet | number }}</span>
        </div>
      </div>
      <div class="stat-card red">
        <div class="icon"><i class="fas fa-times-circle"></i></div>
        <div class="info">
          <span class="lbl">Từ chối</span>
          <span class="val">{{ statistics.tuChoi | number }}</span>
        </div>
      </div>
    </div>
  }

  <div class="toolbar">
    <div class="toolbar-left">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" [(ngModel)]="keyword" placeholder="Tìm kiếm bộ câu hỏi..." (keyup.enter)="page=0; loadData()">
      </div>

      <div class="custom-dropdown-container">
        <div class="dropdown-trigger" (click)="toggleStatusDropdown()">
          <span class="selected-text">{{ getStatusDisplay() }}</span>
          <i class="fas fa-chevron-down arrow" [class.rotate]="showStatusDropdown"></i>
        </div>
        @if (showStatusDropdown) {
          <div class="dropdown-options-list animate-fade-down">
            @for (opt of trangThaiOptions; track opt.value) {
              <div class="dropdown-item" [class.active]="trangThai === opt.value" (click)="selectStatus(opt.value)">
                {{ opt.label }}
              </div>
            }
          </div>
          <div class="backdrop-click" (click)="closeAllDropdowns()"></div>
        }
      </div>

      <div class="custom-dropdown-container">
        <div class="dropdown-trigger" (click)="toggleChuDeDropdown()">
          <span class="selected-text">{{ getChuDeDisplay() }}</span>
          <i class="fas fa-chevron-down arrow" [class.rotate]="showChuDeDropdown"></i>
        </div>
        @if (showChuDeDropdown) {
          <div class="dropdown-options-list animate-fade-down">
            <div class="dropdown-item" [class.active]="chuDeId === 0" (click)="selectChuDe(0)">Tất cả chủ đề</div>
            @for (cd of chuDes; track cd.id) {
              <div class="dropdown-item" [class.active]="chuDeId === cd.id" (click)="selectChuDe(cd.id)">
                {{ cd.ten }}
              </div>
            }
          </div>
          <div class="backdrop-click" (click)="closeAllDropdowns()"></div>
        }
      </div>

      <button class="btn-icon-text" (click)="showAdvancedFilter = !showAdvancedFilter" [class.active]="showAdvancedFilter">
        <i class="fas fa-sliders-h"></i> Lọc nâng cao
      </button>
    </div>

    <button class="btn-icon-text reset-btn" (click)="resetFilters()" title="Đặt lại bộ lọc">
      <i class="fas fa-undo"></i>
    </button>
  </div>

  @if (showAdvancedFilter) {
    <div class="advanced-filter-panel animate-fade-down">

      <div class="filter-group">
        <label>Loại sử dụng</label>
        <div class="custom-dropdown-container">
          <div class="dropdown-trigger" (click)="toggleUsageDropdown()">
            <span class="selected-text">{{ getUsageDisplay() }}</span>
            <i class="fas fa-chevron-down arrow" [class.rotate]="showUsageDropdown"></i>
          </div>
          @if (showUsageDropdown) {
            <div class="dropdown-options-list animate-fade-down">
              @for (opt of loaiSuDungOptions; track opt.value) {
                <div class="dropdown-item" [class.active]="loaiSuDung === opt.value" (click)="selectUsage(opt.value)">
                  {{ opt.label }}
                </div>
              }
            </div>
            <div class="backdrop-click" (click)="closeAllDropdowns()"></div>
          }
        </div>
      </div>

      <div class="filter-group">
        <label>Phí tham gia</label>
        <div class="custom-dropdown-container">
          <div class="dropdown-trigger" (click)="toggleFeeDropdown()">
            <span class="selected-text">{{ getFeeDisplay() }}</span>
            <i class="fas fa-chevron-down arrow" [class.rotate]="showFeeDropdown"></i>
          </div>
          @if (showFeeDropdown) {
            <div class="dropdown-options-list animate-fade-down">
              @for (opt of loaiOptions; track opt.value) {
                <div class="dropdown-item" [class.active]="muonTaoTraPhi === opt.value" (click)="selectFee(opt.value)">
                  {{ opt.label }}
                </div>
              }
            </div>
            <div class="backdrop-click" (click)="closeAllDropdowns()"></div>
          }
        </div>
      </div>

      <div class="filter-group">
        <label>Sắp xếp</label>
        <div class="custom-dropdown-container">
          <div class="dropdown-trigger" (click)="toggleSortDropdown()">
            <span class="selected-text">{{ getSortDisplay() }}</span>
            <i class="fas fa-chevron-down arrow" [class.rotate]="showSortDropdown"></i>
          </div>
          @if (showSortDropdown) {
            <div class="dropdown-options-list animate-fade-down">
              @for (opt of sortOptions; track opt.value) {
                <div class="dropdown-item" [class.active]="sortOrder === opt.value" (click)="selectSort(opt.value)">
                  {{ opt.label }}
                </div>
              }
            </div>
            <div class="backdrop-click" (click)="closeAllDropdowns()"></div>
          }
        </div>
      </div>

    </div>
  }

  @if (hasSelection) {
    <div class="bulk-actions-bar animate-fade-up">
      <div class="bulk-left">
        <span class="count">{{ selectedItems.size }}</span> item đang chọn
        <button class="btn-link" (click)="selectedItems.clear()">Hủy chọn</button>
      </div>
      <div class="bulk-right">
        <button class="btn-bulk approve" (click)="bulkApprove()"><i class="fas fa-check"></i> Duyệt</button>
        <button class="btn-bulk reject" (click)="bulkReject()"><i class="fas fa-times"></i> Từ chối</button>
      </div>
    </div>
  }

  <div class="table-card custom-scrollbar">
    @if (loading) {
      <div class="loading-state">
        <div class="spinner"></div>
        Đang tải dữ liệu...
      </div>
    } @else {
      <table class="modern-table">
        <thead>
        <tr>
          <th class="w-check">
            <input type="checkbox" [checked]="isAllSelected" (change)="toggleSelectAll()">
          </th>
          <th class="w-info">Bộ Câu Hỏi</th>
          <th>Chủ đề</th>
          <th>Tác giả</th>
          <th>Thuộc tính</th>
          <th>Trạng thái</th>
          <th class="text-right">Thao tác</th>
        </tr>
        </thead>
        <tbody>
          @if (items.length === 0) {
            <tr>
              <td colspan="7" class="empty-state">Không tìm thấy dữ liệu phù hợp.</td>
            </tr>
          }
          @for (quiz of items; track quiz.id) {
            <tr [class.selected]="selectedItems.has(quiz.id)">
              <td>
                <input type="checkbox" [checked]="selectedItems.has(quiz.id)" (change)="toggleSelect(quiz.id)">
              </td>
              <td>
                <div class="quiz-info">
                  <span class="quiz-title">{{ quiz.tieu_de }}</span>
                  <div class="quiz-meta">
                    <span class="q-count"><i class="fas fa-question-circle"></i> {{ quiz.so_cau_hoi || 0 }} câu</span>
                    <span class="q-date"><i class="far fa-clock"></i> {{ quiz.tao_luc | date:'dd/MM/yyyy' }}</span>
                  </div>
                </div>
              </td>
              <td><span class="topic-tag">{{ quiz.chu_de || 'Chưa phân loại' }}</span></td>
              <td>
                <div class="author-cell">
                  <div class="author-avt">{{ (quiz.nguoi_tao || '?')[0] | uppercase }}</div>
                  <span>{{ quiz.nguoi_tao }}</span>
                </div>
              </td>
              <td>
                <div class="tags-cell">
                  @if (quiz.muon_tao_tra_phi) {
                    <span class="tag gold" title="Trả phí"><i class="fas fa-coins"></i> Premium</span>
                  } @else {
                    <span class="tag green" title="Miễn phí"><i class="fas fa-gift"></i> Free</span>
                  }

                  @if (quiz.loai_su_dung === 'RANKED_ONLY') {
                    <span class="tag purple" title="Chỉ đấu hạng"><i class="fas fa-trophy"></i> Rank</span>
                  }
                </div>
              </td>
              <td>
                <span class="status-badge" [ngClass]="quiz.trang_thai">
                  {{ getStatusLabel(quiz.trang_thai) }}
                </span>
              </td>
              <td>
                <div ngbDropdown container="body" placement="bottom-end" class="d-inline-block">
                  <button class="btn-more" ngbDropdownToggle><i class="fas fa-ellipsis-v"></i></button>
                  <div ngbDropdownMenu class="custom-dropdown">
                    <button ngbDropdownItem (click)="navigateDetail(quiz.id)">
                      <i class="fas fa-eye"></i> Xem chi tiết
                    </button>
                    <button ngbDropdownItem (click)="navigateEdit(quiz.id)"><i class="fas fa-edit"></i> Chỉnh sửa
                    </button>

                    @if (quiz.trang_thai === 'CHO_DUYET') {
                      <div class="dropdown-divider"></div>
                      <button ngbDropdownItem class="text-success" (click)="approve(quiz)">
                        <i class="fas fa-check"></i> Duyệt ngay
                      </button>
                      <button ngbDropdownItem class="text-danger" (click)="reject(quiz)">
                        <i class="fas fa-times"></i> Từ chối
                      </button>
                    }
                  </div>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    }
  </div>

  @if (totalPages > 1) {
    <div class="pagination-container">
      <button class="btn-page" (click)="changePage(page - 1)" [disabled]="page === 0"><i
        class="fas fa-chevron-left"></i></button>
      <span class="page-info">Trang {{ page + 1 }} / {{ totalPages }}</span>
      <button class="btn-page" (click)="changePage(page + 1)" [disabled]="page >= totalPages - 1"><i
        class="fas fa-chevron-right"></i></button>
    </div>
  }
</div>
