<div class="rating-container">
  <!-- Stats Summary -->
  @if (stats) {
    <div class="rating-summary">
      <div class="rating-average">
            <span class="average-number">{{
                stats.trung_binh_sao |
                  number:'1.1-1'
              }}</span>
        <div class="stars-display">
          @for (i of [1, 2, 3, 4, 5]; track i) {
            <i
              class="fa-star"
              [class.fas]="i <= stats.trung_binh_sao"
              [class.far]="i > stats.trung_binh_sao">
            </i>
          }
        </div>
        <span class="total-reviews">{{ stats.tong_danh_gia }} đánh
                giá</span>
      </div>

      <div class="rating-distribution">
        @for (star of [5, 4, 3, 2, 1]; track star) {
          <div class="distribution-row">
            <span class="star-label">{{ star }} <i class="fas fa-star"></i></span>
            <div class="progress-bar">
              <div
                class="progress-fill"
                [style.width.%]="getStarPercentage(star)">
              </div>
            </div>
            <span class="star-count">{{ stats.phan_bo_sao[star] || 0 }}</span>
          </div>
        }
      </div>
    </div>
  }


  <!-- My Rating Form -->
  @if (allowRating) {
    <div class="my-rating-section">
      @if (myRating && isEditing) {
        <h4>Chỉnh sửa đánh giá</h4>
      } @else {
        <h4>Đánh giá của bạn</h4>
      }

      @if (!myRating || isEditing) {
        <div class="star-rating-input">
          @for (star of [1, 2, 3, 4, 5]; track star) {
            <i
              class="fa-star star-input"
              [class.fas]="star <= (hoverStar || selectedStar)"
              [class.far]="star > (hoverStar || selectedStar)"
              (mouseenter)="onStarHover(star)"
              (mouseleave)="onStarLeave()"
              (click)="onStarClick(star)">
            </i>
          }
          @if (selectedStar) {
            <span class="star-text">{{ selectedStar }} sao</span>
          }
        </div>
      }

      <!-- Display existing rating -->
      @if (myRating && !isEditing) {
        <div class="existing-rating">
          <div class="my-stars">
            @for (star of [1, 2, 3, 4, 5]; track star) {
              @if (star <= myRating.so_sao) {
                <i class="fas fa-star"></i>
              } @else {
                <i class="far fa-star"></i>
              }
            }
          </div>

          @if (myRating.noi_dung) {
            <p class="my-review-content">{{ myRating.noi_dung }}</p>
          }
          <p class="review-date">
            Đánh giá lúc: {{ formatDate(myRating.cap_nhat_luc) }}
          </p>
          <div class="my-rating-actions">
            <button class="btn btn-sm btn-outline-primary" (click)="isEditing = true">
              <i class="fas fa-edit"></i> Chỉnh sửa
            </button>
            <button class="btn btn-sm btn-outline-danger" (click)="deleteMyRating()">
              <i class="fas fa-trash"></i> Xóa
            </button>
          </div>
        </div>
      }

      <!-- Review textarea -->
      @if (!myRating || isEditing) {
        <div class="review-input">
    <textarea [(ngModel)]="reviewContent"
              placeholder="Viết nhận xét của bạn (tùy chọn)..."
              rows="3">
    </textarea>
          <div class="rating-actions">
            <button class="btn btn-primary"
                    [disabled]="selectedStar === 0 || isSubmitting"
                    (click)="submitRating()">
              @if (isSubmitting) {
                <span class="spinner-border spinner-border-sm"></span>
              }
              {{ myRating ? 'Cập nhật' : 'Gửi đánh giá' }}
            </button>
            @if (isEditing) {
              <button class="btn btn-secondary" (click)="cancelEdit()">
                Hủy
              </button>
            }
          </div>
        </div>
      }
    </div>
  }
  <!-- Reviews List -->
  @if (showReviews && reviews.length > 0) {
    <div class="reviews-list">
      <h4>Nhận xét từ người dùng</h4>
      @for (review of reviews; track review) {
        <div class="review-item">
          <div class="reviewer-info">
            <img
              [src]="getAvatar(review.nguoi_dung_avatar, review.nguoi_dung_ten)"
              alt="avatar"
              class="reviewer-avatar">

            <div class="reviewer-details">
              <span class="reviewer-name">{{ review.nguoi_dung_ten }}</span>

              <div class="reviewer-stars">
                @for (star of [1, 2, 3, 4, 5]; track star) {
                  @if (star <= review.so_sao) {
                    <i class="fas fa-star"></i>
                  } @else {
                    <i class="far fa-star"></i>
                  }
                }
              </div>
            </div>

            <span class="review-date-small">{{ formatDate(review.cap_nhat_luc) }}</span>
          </div>

          @if (review.noi_dung) {
            <p class="review-content">{{ review.noi_dung }}</p>
          }
        </div>
      }
      @if (totalPages > 1) {
        <div class="reviews-pagination">
          <button class="btn btn-sm btn-outline-secondary"
                  [disabled]="currentPage === 0"
                  (click)="prevPage()">
            <i class="fas fa-chevron-left"></i>
          </button>

          <span>{{ currentPage + 1 }} / {{ totalPages }}</span>

          <button class="btn btn-sm btn-outline-secondary"
                  [disabled]="currentPage === totalPages - 1"
                  (click)="nextPage()">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      }
    </div>
  }
  @if (showReviews && reviews.length === 0 && stats?.tong_danh_gia === 0) {
    <div class="no-reviews">
      <p>Chưa có đánh giá nào. Hãy là người đầu tiên đánh giá!</p>
    </div>
  }
</div>
